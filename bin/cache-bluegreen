#!/usr/bin/env bash
set -euo pipefail
#set -x

CACHE_FILE='/tmp/bluegreen-cache.txt'

cache_aws_find_pattern() (
  local pattern="$1"
  local ips=$(cat - | grep -E "${pattern}" | awk '{print $1}')
  declare -A nodeIDs

  eval nodeIDs=( $(nomad node-status -json | jq -r 'map(["[\"" + (.Name | sub("ip-"; "") | gsub("-"; ".")) + "\"]", "\"" + (.ID | sub("-.+$"; "")) + "\""] | join("="))[]'))

  local i=0
  local size=$(echo "${ips}" | wc -l)

  for ip in ${ips}; do
    echo -n "${ip}" >> "${CACHE_FILE}"

    if [[ -n "${nodeIDs[${ip}]:-}" ]]; then
      echo -n "|${nodeIDs[${ip}]}" >> "${CACHE_FILE}"
    fi

    if ((i < size-1)) ; then
      echo -n "|" >> "${CACHE_FILE}"
    fi

    i=$((i+1))
  done

  echo "" >> "${CACHE_FILE}"
)

main() {
  local instances="$(aws-find ec2)"
  echo -n > "${CACHE_FILE}"
  echo "${instances}" | cache_aws_find_pattern "blue|instance-docker"
  echo "${instances}" | cache_aws_find_pattern "green"
}

main "$@"
