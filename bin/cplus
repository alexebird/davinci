#!/bin/bash
set -euo pipefail
#set -x

#usage() {
  #cat <<HERE
#Usage: cplus OPTS

#-h    help me
#HERE

  #exit 1
#}

main() {
  [[ -z "${CONSUL_HTTP_ADDR}" ]] && { echo 'must run nomad-env' ; exit 1 ; }

  #while getopts "jh" opt; do
    #case "${opt}" in
      #j)
        #json='true'
        #;;
      #h)
        #usage
        #;;
      #\?)
        #usage
        #;;
      #:)
        #usage
        #;;
    #esac
  #done

  #shift $(($OPTIND - 1))
  #local args="$*"

  #if [[ "$#" -eq 0 ]]; then
    #all_jobs | job_table "${json}"
  #else
    #one_job "$1" | job_table "${json}"
  #fi

  curl -L -s "${CONSUL_HTTP_ADDR}/v1/catalog/services" \
    | jq -r '. | keys | sort[]' \
    | grep "$1" \
    | parallel --keep-order "curl -L -s ${CONSUL_HTTP_ADDR}/v1/health/service/{1}" \
    | jq -s -r -f "${DAVINCI_CLONE}/jq/cplus/consul-services.jq" \
    | tableme SERVICE NODE STATUS
}

main "$@"
